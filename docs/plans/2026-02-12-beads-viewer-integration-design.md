# Beads Viewer Deep Integration Design

**Date:** 2026-02-12
**Status:** Approved

## Overview

Integrate beads_viewer (bv) deeply into the nuclode agentic workspace. Currently nuclode has surface-level bv support (install check in setup.sh, `bv --robot-next` in CLAUDE.md). This design adds full workflow integration: graph-aware agent context, auto-generated dependency graphs, and opt-in parallel task orchestration.

## Architecture

Two layers:

**Core wiring** (always present, lightweight):
- 3-tier agent session startup context injection via bv
- Export hooks for auto-generated Mermaid dependency graphs
- Graceful degradation when bv is not installed or no `.beads/` exists

**Opt-in skill** (`beads-graph-orchestration`):
- Graph-driven parallel task dispatch with human confirmation
- Mermaid diagram embedding in plan documents (3+ dependency nodes)
- Invoked explicitly, never auto-loaded

## Decision Log

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Integration scope | Full workflow | Maximize bv's graph intelligence across agents |
| Task dispatch model | Plan-first, confirm-dispatch | Human-in-the-loop before agents fan out |
| Session context | 3-tier by agent role | Right-size token budget per agent purpose |
| Graph export | Hook-based (post-export) | Living documentation, stays current automatically |
| Plan graph embedding | Non-trivial only (3+ deps) | Avoid bloat on simple task lists |
| Code organization | Core + opt-in skill | Basic wiring always available, orchestration is optional |

## Session Startup: 3-Tier Context Injection

When an agent session starts in a project with `.beads/beads.jsonl`, inject bv context based on agent tier.

### Tier 1: Executor (~800 tokens)
**Agents:** code-implementer, test-writer

```bash
bv --robot-triage --format toon
```

Returns: top recommendations, quick wins, project health score. Enough for agents to understand project state before executing tasks.

### Tier 2: Reviewer (~1500 tokens)
**Agents:** code-reviewer

```bash
bv --robot-triage --format toon
bv --robot-graph --fmt mermaid  # relevant subgraph
```

Returns: triage data + dependency graph. Reviewers need blast radius context to assess impact of changes.

### Tier 3: Strategist (~3000 tokens)
**Agents:** code-planner, active-defender

```bash
bv --robot-triage --format toon
bv --robot-insights --format toon
bv --robot-graph --fmt mermaid
```

Returns: full metrics (PageRank bottlenecks, critical path, betweenness gatekeepers, cycle warnings) + dependency graph. Code-planner uses this for dependency-aware plans. Active-defender uses it to map cross-boundary attack surfaces.

### Truncation

If output exceeds tier budget, truncate with: `[truncated -- run bv --robot-insights for full output]` so agents know more is available on demand.

### Graceful Degradation

All tiers check: `command -v bv && [ -f .beads/beads.jsonl ]`. If either fails, skip silently. No errors, no nagging.

## Init Hooks: Auto-Generated Dependency Graphs

### Changes to `templates/beads-init.sh`

After `bd init`, if `bv` is installed, append hook configuration to `.beads/config.yaml`:

```yaml
hooks:
  post-export:
    - command: "bv --robot-graph --fmt mermaid > docs/dependency-graph.md"
      description: "Auto-generate Mermaid dependency graph on export"
```

### Hook Script: `core/beads/hooks/post-export-graph.sh`

Responsibilities:
- Check `bv` is available (graceful skip if not)
- Run `bv --robot-graph --fmt mermaid`
- Write to `docs/dependency-graph.md` with header: `<!-- Auto-generated by bv. Do not edit manually. -->`
- Only write if graph content has changed (avoids noisy git diffs)
- Create `docs/` directory only when needed

### Opt-out

Users remove the hook from `.beads/config.yaml`. The hook script checks for its own config before running.

## Opt-In Skill: `beads-graph-orchestration`

### Trigger

Invoked explicitly by user or agent. Not auto-loaded.

### Flow

1. Run `bv --robot-plan` -- returns JSON with parallel execution tracks
2. Present tracks visually:
   ```
   Track 1 (parallel): Task #3 "Add auth middleware", Task #7 "Create DB schema"
   Track 2 (parallel): Task #4 "Auth endpoints" (blocked by #3), Task #8 "Seed data" (blocked by #7)
   Track 3 (sequential): Task #12 "Integration tests" (blocked by #4, #8)
   ```
3. Ask: "Ready to dispatch these tracks?"
4. On confirmation, dispatch parallel agents per track using dispatching-parallel-agents pattern
5. After each track completes, run `bv --robot-next` to revalidate (graph may have changed)

### Graph Embedding in Plans

When this skill writes a plan document and the task DAG has 3+ nodes with dependencies, include a Mermaid diagram inline. Simple linear task lists skip the diagram.

## File Changes

### New Files (3)

| File | Purpose |
|------|---------|
| `core/skills/beads-graph-orchestration.md` | Opt-in orchestration skill |
| `core/beads/hooks/post-export-graph.sh` | Export hook for Mermaid generation |
| `docs/plans/2026-02-12-beads-viewer-integration-design.md` | This design document |

### Modified Files (5)

| File | Change |
|------|--------|
| `core/beads/AGENT_INSTRUCTIONS.md` | Add 3-tier bv context injection at session start |
| `core/agents/code-planner/system_prompt.md` | Add strategist-tier bv instructions |
| `core/agents/active-defender/system_prompt.md` | Add strategist-tier bv instructions |
| `core/agents/code-reviewer/system_prompt.md` | Add reviewer-tier bv instructions |
| `templates/beads-init.sh` | Add bv hook configuration after `bd init` |

### Untouched

- `setup.sh` -- already handles bv installation
- `core/CLAUDE.md` -- already references bv
- Agent `agent.json` files -- no tool/capability changes
- Executor agent prompts -- inherit from AGENT_INSTRUCTIONS.md
