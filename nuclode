#!/bin/bash
# nuclode - Agentic workspace CLI
# Usage: nuclode <command> [args]
#
# First time:  git clone <repo> ~/dev/nuclode && ./nuclode install
# After that:  nuclode update | init | analyze | help

set -e

NUCLODE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLAUDE_DIR="$HOME/.claude"
TEMPLATES_DIR="$NUCLODE_DIR/templates"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

info()  { echo -e "${BLUE}[info]${NC} $1"; }
ok()    { echo -e "${GREEN}[ok]${NC} $1"; }
warn()  { echo -e "${YELLOW}[warn]${NC} $1"; }
error() { echo -e "${RED}[error]${NC} $1"; }

# ─── Commands ─────────────────────────────────────────────────────────

cmd_install() {
    local NO_BACKUP=false
    while [[ $# -gt 0 ]]; do
        case $1 in
            --no-backup) NO_BACKUP=true; shift ;;
            *) shift ;;
        esac
    done

    BACKUP_DIR="$HOME/.claude.backup.$(date +%Y%m%d-%H%M%S)"

    echo ""
    echo "  ╔═══════════════════════════════════════╗"
    echo "  ║     nuclode - Agentic Workspace       ║"
    echo "  ║   nu + claude + code = nucleotide     ║"
    echo "  ╚═══════════════════════════════════════╝"
    echo ""

    # ─── Step 1: Prerequisites ────────────────────────────────────────
    info "Checking prerequisites..."

    # Check Claude Code CLI
    if command -v claude &> /dev/null; then
        ok "Claude Code CLI found"
    else
        warn "Claude Code CLI not found. Install from: https://claude.ai/claude-code"
    fi

    # Install beads
    if command -v bd &> /dev/null; then
        ok "beads (bd) found: $(bd --version 2>/dev/null || echo 'installed')"
    else
        info "Installing beads (bd)..."
        if command -v brew &> /dev/null; then
            brew install beads
        elif command -v npm &> /dev/null; then
            npm install -g @beads/bd
        else
            curl -fsSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash
        fi
        ok "beads installed"
    fi

    # Install beads viewer
    if command -v bv &> /dev/null; then
        ok "beads viewer (bv) found"
    else
        info "Installing beads viewer (bv)..."
        if command -v brew &> /dev/null; then
            brew install dicklesworthstone/tap/bv
        else
            curl -fsSL "https://raw.githubusercontent.com/Dicklesworthstone/beads_viewer/main/install.sh" | bash
        fi
        ok "beads viewer installed"
    fi

    # Install jq
    if command -v jq &> /dev/null; then
        ok "jq found"
    else
        info "Installing jq..."
        if command -v brew &> /dev/null; then
            brew install jq
        elif command -v apt-get &> /dev/null; then
            sudo apt-get install -y jq
        else
            error "Could not install jq automatically. Please install it manually."
        fi
        ok "jq installed"
    fi

    # ─── Step 2: Backup ──────────────────────────────────────────────
    if [ -d "$CLAUDE_DIR" ] && [ "$NO_BACKUP" = false ]; then
        info "Backing up existing ~/.claude to $BACKUP_DIR"

        cp -r "$CLAUDE_DIR" "$BACKUP_DIR"
        ok "Backup created at $BACKUP_DIR"

        PRESERVED_FILES=()
        if [ -f "$CLAUDE_DIR/settings.local.json" ]; then
            PRESERVED_FILES+=("settings.local.json")
        fi
        if [ -d "$CLAUDE_DIR/memory" ]; then
            PRESERVED_FILES+=("memory/")
        fi
        if [ ${#PRESERVED_FILES[@]} -gt 0 ]; then
            info "Will preserve: ${PRESERVED_FILES[*]}"
        fi
    fi

    # ─── Step 3: Install Workspace ───────────────────────────────────
    info "Installing workspace..."

    mkdir -p "$CLAUDE_DIR"/{agents,commands/agents,hooks,skills,beads}

    cp "$NUCLODE_DIR/workspace/CLAUDE.md" "$CLAUDE_DIR/CLAUDE.md"
    cp "$NUCLODE_DIR/workspace/AGENTS.md" "$CLAUDE_DIR/AGENTS.md"
    cp "$NUCLODE_DIR/workspace/agents/README.md" "$CLAUDE_DIR/agents/README.md"

    for agent_dir in "$NUCLODE_DIR"/workspace/agents/*/; do
        if [ -d "$agent_dir" ]; then
            agent_name=$(basename "$agent_dir")
            mkdir -p "$CLAUDE_DIR/agents/$agent_name"
            cp "$agent_dir"/* "$CLAUDE_DIR/agents/$agent_name/"
        fi
    done

    cp "$NUCLODE_DIR"/workspace/commands/agents/*.md "$CLAUDE_DIR/commands/agents/"
    for cmd_file in "$NUCLODE_DIR"/workspace/commands/*.md; do
        if [ -f "$cmd_file" ]; then
            cp "$cmd_file" "$CLAUDE_DIR/commands/"
        fi
    done

    cp "$NUCLODE_DIR"/workspace/beads/* "$CLAUDE_DIR/beads/"

    if [ -d "$NUCLODE_DIR/workspace/hooks" ]; then
        cp "$NUCLODE_DIR"/workspace/hooks/* "$CLAUDE_DIR/hooks/"
        chmod +x "$CLAUDE_DIR/hooks/"*.sh 2>/dev/null || true
        ok "Network guard hooks installed"
    fi

    cp "$NUCLODE_DIR/workspace/settings.json" "$CLAUDE_DIR/settings.json"
    cp "$NUCLODE_DIR/workspace/.mcp.json" "$CLAUDE_DIR/.mcp.json"

    ok "Workspace installed"

    # ─── Step 4: Restore Preserved Files ─────────────────────────────
    if [ -d "${BACKUP_DIR:-}" ]; then
        if [ -f "$BACKUP_DIR/settings.local.json" ]; then
            cp "$BACKUP_DIR/settings.local.json" "$CLAUDE_DIR/settings.local.json"
            ok "Restored settings.local.json"
        fi
        if [ -d "$BACKUP_DIR/memory" ]; then
            cp -r "$BACKUP_DIR/memory" "$CLAUDE_DIR/memory"
            ok "Restored memory/"
        fi
    fi

    # ─── Step 5: Install Shell Functions ──────────────────────────────
    if [ -f "$NUCLODE_DIR/shell/nuclode.sh" ]; then
        mkdir -p "$CLAUDE_DIR/shell"
        cp "$NUCLODE_DIR/shell/nuclode.sh" "$CLAUDE_DIR/shell/nuclode.sh"

        SHELL_PROFILE=""
        if [ -f "$HOME/.zshrc" ]; then
            SHELL_PROFILE="$HOME/.zshrc"
        elif [ -f "$HOME/.bashrc" ]; then
            SHELL_PROFILE="$HOME/.bashrc"
        elif [ -f "$HOME/.bash_profile" ]; then
            SHELL_PROFILE="$HOME/.bash_profile"
        fi

        if [ -n "$SHELL_PROFILE" ]; then
            SOURCE_LINE="source $CLAUDE_DIR/shell/nuclode.sh"
            if ! grep -qF "$SOURCE_LINE" "$SHELL_PROFILE" 2>/dev/null; then
                echo "" >> "$SHELL_PROFILE"
                echo "# nuclode shell functions" >> "$SHELL_PROFILE"
                echo "$SOURCE_LINE" >> "$SHELL_PROFILE"
                ok "Added shell functions to $(basename "$SHELL_PROFILE")"
                info "Available: claude-worktree (cw), remove-worktrees"
            else
                ok "Shell functions already sourced in $(basename "$SHELL_PROFILE")"
            fi
        else
            warn "Could not detect shell profile. Add manually:"
            echo "  source $CLAUDE_DIR/shell/nuclode.sh"
        fi
    fi

    # ─── Step 6: Install CLI to PATH ─────────────────────────────────
    info "Installing nuclode CLI..."

    NUCLODE_BIN="$HOME/.local/bin/nuclode"
    mkdir -p "$HOME/.local/bin"

    # Symlink the repo's nuclode script to PATH
    ln -sf "$NUCLODE_DIR/nuclode" "$NUCLODE_BIN"

    # Store the source directory reference
    echo "$NUCLODE_DIR" > "$CLAUDE_DIR/.nuclode-source"

    ok "nuclode CLI installed to $NUCLODE_BIN"

    if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
        warn "$HOME/.local/bin is not in your PATH"
        echo "  Add to your shell profile:"
        echo "    export PATH=\"\$HOME/.local/bin:\$PATH\""
    fi

    # ─── Done! ────────────────────────────────────────────────────────
    echo ""
    echo "  ╔═══════════════════════════════════════╗"
    echo "  ║      nuclode installed!               ║"
    echo "  ╚═══════════════════════════════════════╝"
    echo ""
    echo "  Workspace: $CLAUDE_DIR"
    echo "  CLI:       $NUCLODE_BIN"
    if [ -d "${BACKUP_DIR:-}" ]; then
        echo "  Backup:    $BACKUP_DIR"
    fi
    echo ""
    echo "  Next steps:"
    echo "    1. Start a Claude Code session"
    echo "    2. Run 'nuclode init' in any project for beads"
    echo "    3. Use /agents:code-planner to plan features"
    echo ""
}

cmd_update() {
    echo "Updating nuclode from: $NUCLODE_DIR"
    cd "$NUCLODE_DIR"
    git pull
    exec "$NUCLODE_DIR/nuclode" install --no-backup
}

cmd_init() {
    if [ -f "$TEMPLATES_DIR/beads-init.sh" ]; then
        bash "$TEMPLATES_DIR/beads-init.sh" "${1:-.}"
    else
        error "nuclode templates not found at $TEMPLATES_DIR"
        exit 1
    fi
}

cmd_analyze() {
    if [ -z "$1" ]; then
        error "Usage: nuclode analyze <path/to/project> [options]"
        echo ""
        echo "  Options:"
        echo "    --mode <structure|security>  Analysis mode (default: structure)"
        echo "    --force                      Skip staleness check"
        echo "    --nrepl-port <port>          Clojure nREPL port"
        echo "    --dry-run                    Load context only, no API calls"
        echo "    --verbose                    Debug logging"
        exit 1
    fi
    python3 -m knowledge.recipes.codebase_analysis "$@"
}

cmd_help() {
    echo "nuclode - Agentic workspace CLI"
    echo ""
    echo "Commands:"
    echo "  install          Install workspace, dependencies, and CLI"
    echo "  update           Pull latest nuclode and re-install"
    echo "  init [dir]       Initialize beads in a project directory"
    echo "  analyze <path>   Run codebase analysis on a project"
    echo "  help             Show this help"
    echo ""
    echo "First time:"
    echo "  git clone <repo> ~/dev/nuclode"
    echo "  cd ~/dev/nuclode && ./nuclode install"
    echo ""
    echo "Source: $NUCLODE_DIR"
}

# ─── Main ─────────────────────────────────────────────────────────────

case "${1:-help}" in
    install)  shift; cmd_install "$@" ;;
    update)   shift; cmd_update "$@" ;;
    init)     shift; cmd_init "$@" ;;
    analyze)  shift; cmd_analyze "$@" ;;
    help|--help|-h) cmd_help ;;
    *)
        error "Unknown command: $1"
        echo "Run 'nuclode help' for usage"
        exit 1
        ;;
esac
